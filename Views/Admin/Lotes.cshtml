@model IEnumerable<juego_MVC_bomber.Models.LOTES>
@{
    ViewBag.Title = "Gestión de Lotes";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    /* ===== ESTILOS PARA GESTIÓN DE LOTES ===== */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .page-title {
        font-family: 'Press Start 2P', cursive;
        font-size: 16px;
        color: #d0af73;
        text-shadow: 3px 3px 0 #000;
    }

    .page-subtitle {
        font-family: 'Press Start 2P', cursive;
        font-size: 8px;
        color: #71ab93;
        margin-top: 5px;
    }

    .btn-new {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #e94e1f;
        color: #fff;
        padding: 12px 20px;
        border: 4px solid #d0af73;
        text-decoration: none;
        font-family: 'Press Start 2P', cursive;
        font-size: 9px;
        transition: all 0.1s;
        box-shadow: 0 4px 0 #a03517;
    }

        .btn-new:hover {
            background: #ff6a3d;
            transform: translate(-2px, -2px);
            box-shadow: 0 4px 0 #a03517, -3px -3px 0 #d0af73;
            color: #fff;
        }

    /* Info Box - Lote Actual */
    .current-lote-box {
        background: #000;
        border: 4px solid #71ab93;
        padding: 20px;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 20px;
        box-shadow: 4px 4px 0 #039c98;
    }

    .current-lote-icon {
        font-size: 40px;
        animation: pulse 2s infinite;
    }

    @@keyframes pulse {
        0%, 100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.1);
        }
    }

    .current-lote-info h3 {
        font-family: 'Press Start 2P', cursive;
        font-size: 8px;
        color: #71ab93;
        margin-bottom: 5px;
    }

    .current-lote-info .name {
        font-family: 'Press Start 2P', cursive;
        font-size: 12px;
        color: #d0af73;
        text-shadow: 1px 1px 0 #000;
    }

    /* Stats Bar */
    .stats-bar {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
        flex-wrap: wrap;
    }

    .stat-item {
        background: #000;
        border: 3px solid #039c98;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-family: 'Press Start 2P', cursive;
    }

        .stat-item .number {
            font-size: 14px;
            color: #d0af73;
        }

        .stat-item .label {
            font-size: 8px;
            color: #71ab93;
        }

    /* Alert Messages */
    .alert {
        padding: 15px 20px;
        border: 4px solid;
        margin-bottom: 20px;
        font-family: 'Press Start 2P', cursive;
        font-size: 9px;
        line-height: 1.8;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .alert-success {
        background: rgba(113, 171, 147, 0.2);
        border-color: #71ab93;
        color: #71ab93;
    }

    .alert-error {
        background: rgba(233, 78, 31, 0.2);
        border-color: #e94e1f;
        color: #e94e1f;
    }

    /* Lotes Grid */
    .lotes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
    }

    .lote-card {
        background: #000;
        border: 4px solid #333;
        box-shadow: 4px 4px 0 #1a1a1a;
        overflow: hidden;
        transition: all 0.1s;
        position: relative;
    }

        .lote-card:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 #1a1a1a;
            border-color: #d0af73;
        }

        .lote-card.is-default {
            border-color: #71ab93;
            box-shadow: 4px 4px 0 #039c98, 0 0 20px rgba(113, 171, 147, 0.3);
        }

            .lote-card.is-default::before {
                content: '⭐ EN USO';
                position: absolute;
                top: 10px;
                right: 10px;
                background: #71ab93;
                color: #000;
                padding: 5px 10px;
                font-family: 'Press Start 2P', cursive;
                font-size: 7px;
                z-index: 10;
                border: 2px solid #d0af73;
            }

    /* Lote Images Preview */
    .lote-images {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 2px;
        background: #1a1a1a;
        padding: 2px;
    }

        .lote-images img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            image-rendering: pixelated;
            border: 2px solid #333;
        }

        .lote-images .no-image {
            width: 100%;
            aspect-ratio: 1;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border: 2px solid #333;
        }

    /* Lote Info */
    .lote-info {
        padding: 15px;
    }

    .lote-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
        gap: 10px;
    }

    .lote-name {
        font-family: 'Press Start 2P', cursive;
        font-size: 10px;
        color: #d0af73;
        text-shadow: 1px 1px 0 #000;
        word-break: break-word;
    }

    .lote-meta {
        display: flex;
        flex-direction: column;
        gap: 5px;
        margin-bottom: 15px;
    }

    .lote-meta-item {
        font-family: 'Press Start 2P', cursive;
        font-size: 7px;
        color: #888;
        display: flex;
        align-items: center;
        gap: 8px;
    }

        .lote-meta-item strong {
            color: #71ab93;
        }

    /* Lote Actions */
    .lote-actions {
        display: flex;
        gap: 10px;
    }

    .btn-action {
        flex: 1;
        padding: 10px 12px;
        font-family: 'Press Start 2P', cursive;
        font-size: 8px;
        border: 3px solid;
        cursor: pointer;
        transition: all 0.1s;
        text-align: center;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    /* Botón Seleccionar como Default */
    .btn-select {
        background: #1a1a1a;
        border-color: #71ab93;
        color: #71ab93;
        box-shadow: 0 3px 0 #026866;
    }

        .btn-select:hover {
            background: #71ab93;
            color: #000;
            transform: translateY(-2px);
            box-shadow: 0 5px 0 #026866;
        }

    /* Botón cuando ya es Default */
    .btn-selected {
        background: #71ab93;
        border-color: #d0af73;
        color: #000;
        cursor: default;
        box-shadow: none;
    }

        .btn-selected:hover {
            transform: none;
        }

    /* Botón Eliminar */
    .btn-delete {
        background: transparent;
        border-color: #e94e1f;
        color: #e94e1f;
        box-shadow: 0 3px 0 #a03517;
    }

        .btn-delete:hover {
            background: #e94e1f;
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 5px 0 #a03517;
        }

        .btn-delete:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            box-shadow: none;
        }

            .btn-delete:disabled:hover {
                background: transparent;
                color: #e94e1f;
                transform: none;
            }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: #000;
        border: 4px solid #d0af73;
    }

    .empty-icon {
        font-size: 60px;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    .empty-state h3 {
        font-family: 'Press Start 2P', cursive;
        font-size: 12px;
        color: #d0af73;
        margin-bottom: 10px;
    }

    .empty-state p {
        font-family: 'Press Start 2P', cursive;
        font-size: 8px;
        color: #71ab93;
        margin-bottom: 20px;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .page-header {
            flex-direction: column;
            text-align: center;
        }

        .current-lote-box {
            flex-direction: column;
            text-align: center;
        }

        .stats-bar {
            justify-content: center;
        }

        .lotes-grid {
            grid-template-columns: 1fr;
        }

        .lote-actions {
            flex-direction: column;
        }

        .btn-action {
            width: 100%;
        }
    }
</style>

<div class="lotes-container">
    <!-- Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">GESTIÓN DE LOTES</h1>
            <p class="page-subtitle">Selecciona el lote de imágenes para el juego</p>
        </div>
        <a href="@Url.Action("LoteCrear", "Admin")" class="btn-new">
            + NUEVO LOTE
        </a>
    </div>

    <!-- Mensajes -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">
            <span>✓</span> @TempData["Success"]
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-error">
            <span>⚠️</span> @TempData["Error"]
        </div>
    }

    <!-- Lote Actual en Uso -->
    @{
        var loteActual = Model.FirstOrDefault(l => l.EsDefault);
    }

    <div class="current-lote-box">
        <div class="current-lote-icon">🎮</div>
        <div class="current-lote-info">
            <h3>LOTE ACTIVO EN EL JUEGO:</h3>
            @if (loteActual != null)
            {
                <span class="name">@loteActual.Nombre</span>
            }
            else
            {
                <span class="name" style="color: #e94e1f;">⚠️ NINGUNO SELECCIONADO</span>
            }
        </div>
    </div>

    <!-- Stats Bar -->
    @{
        var totalLotes = Model.Count();
        var aprobados = Model.Count(l => l.Estado == "APROBADO");
    }

    <div class="stats-bar">
        <div class="stat-item">
            <div>
                <div class="number">@totalLotes</div>
                <div class="label">TOTAL LOTES</div>
            </div>
        </div>
        <div class="stat-item">
            <div>
                <div class="number">@aprobados</div>
                <div class="label">DISPONIBLES</div>
            </div>
        </div>
    </div>

    <!-- Lotes Grid -->
    @if (Model.Any())
    {
        <div class="lotes-grid">
            @foreach (var lote in Model.Where(l => l.Estado == "APROBADO"))
            {
                bool esDefault = lote.EsDefault;
                string cardClass = esDefault ? "lote-card is-default" : "lote-card";

                <div class="@cardClass">
                    <!-- Images Preview -->
                    <div class="lote-images">
                        @if (lote.IMAGENES_LOTE != null && lote.IMAGENES_LOTE.Any())
                        {
                            foreach (var img in lote.IMAGENES_LOTE.OrderBy(i => i.Orden).Take(5))
                            {
                                <img src="@img.ImagenRuta" alt="Imagen @img.Orden" />
                            }
                            for (int i = lote.IMAGENES_LOTE.Count(); i < 5; i++)
                            {
                                <div class="no-image">❓</div>
                            }
                        }
                        else
                        {
                            for (int i = 0; i < 5; i++)
                            {
                                <div class="no-image">❓</div>
                            }
                        }
                    </div>

                    <!-- Info -->
                    <div class="lote-info">
                        <div class="lote-header">
                            <span class="lote-name">@lote.Nombre</span>
                        </div>

                        <div class="lote-meta">
                            <div class="lote-meta-item">
                                <span>Creado por: <strong>@(lote.USUARIOS?.Nombre ?? "Sistema")</strong></span>
                            </div>
                            <div class="lote-meta-item">
                                <span>@lote.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</span>
                            </div>
                            <div class="lote-meta-item">
                                <span><strong>@(lote.IMAGENES_LOTE?.Count() ?? 0)</strong> imágenes</span>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="lote-actions">
                            @if (esDefault)
                            {
                                <!-- Ya es el Default -->
                                <button type="button" class="btn-action btn-selected" disabled>
                                    ✓ SELECCIONADO
                                </button>
                                <!-- No se puede eliminar el default -->
                                <button type="button" class="btn-action btn-delete" disabled title="No puedes eliminar el lote activo">
                                    🗑️
                                </button>
                            }
                            else
                            {
                                <!-- Botón para hacer Default -->
                                using (Html.BeginForm("LoteSetDefault", "Admin", new { id = lote.IdLote }, FormMethod.Post, new { style = "flex: 1;" }))
                                {
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn-action btn-select" style="width: 100%;">
                                        ☐ SELECCIONAR
                                    </button>
                                }
                                <!-- Botón Eliminar -->
                                using (Html.BeginForm("LoteEliminar", "Admin", new { id = lote.IdLote }, FormMethod.Post, new { style = "flex: 0 0 50px;" }))
                                {
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn-action btn-delete" onclick="return confirm('⚠️ ¿Eliminar este lote?\n\nEsta acción no se puede deshacer.');">
                                        🗑️
                                    </button>
                                }
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-icon">📦</div>
            <h3>NO HAY LOTES</h3>
            <p>Crea el primer lote de imágenes para el juego</p>
            <a href="@Url.Action("LoteCrear", "Admin")" class="btn-new">
                + CREAR LOTE
            </a>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Auto-ocultar alertas
        setTimeout(() => {
            document.querySelectorAll('.alert').forEach(alert => {
                alert.style.transition = 'opacity 0.5s';
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 500);
            });
        }, 4000);
    </script>
}
